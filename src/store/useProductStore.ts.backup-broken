import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { Product, ProductReview } from '../types';

interface ProductStore {
  products: Product[];
  setProducts: (products: Product[]) => void;
  addProduct: (product: Product) => void;
  updateProduct: (id: string, product: Partial<Product>) => void;
  deleteProduct: (id: string) => void;
  getProductById: (id: string) => Product | undefined;
  getProductBySlug: (slug: string) => Product | undefined;
  getProductsByCustomLanding: (landingPage: string) => Product[];
  getProductsByCategory: (category: string) => Product[];
  getAvailableProducts: () => Product[];
  searchProducts: (query: string) => Product[];
  addReview: (productSlug: string, review: Omit<ProductReview, 'id' | 'date'>) => void;
  updateReviewStatus: (productId: string, reviewId: string, status: 'pending' | 'approved' | 'rejected') => void;
  deleteReview: (productId: string, reviewId: string) => void;
}

export const useProductStore = create<ProductStore>()(
  persist(
    (set, get) => ({
      products: [
        {
          id: '1',
          slug: 'cinta-modeladora',
          name: 'Cinta Modeladora',
          description: 'Cinta modeladora de alta compressÃ£o para definiÃ§Ã£o corporal instantÃ¢nea. Proporciona conforto durante todo o dia e realÃ§a suas curvas naturais.',
          price: 297.00,
          image: 'https://images.unsplash.com/photo-1594824476967-48c8b964273f?w=800&h=800&fit=crop',
          images: [
            'https://images.unsplash.com/photo-1594824476967-48c8b964273f?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1583394293214-28ded15ee548?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1583394838336-acd977736f90?w=800&h=800&fit=crop',
          ],
          category: 'Modeladores',
          stock: 45,
          badge: 'bestseller',
          rating: 4.9,
          reviews: 567,
          benefits: [
            'Modelagem corporal instantÃ¢nea',
            'Reduz medidas imediatamente',
            'Melhora a postura',
            'Aumenta a autoestima',
            'ConfortÃ¡vel para uso prolongado',
            'Tecido respirÃ¡vel e antialÃ©rgico',
          ],
          howToUse: [
            'Vista a cinta pela parte inferior do corpo',
            'Ajuste confortavelmente na regiÃ£o do abdÃ´men',
            'Use diariamente por pelo menos 8 horas',
            'Pode ser usada por baixo das roupas',
          ],
          whyChoose: [
            'Resultados Imediatos',
            'Conforto Durante o Dia Todo',
            'Material RespirÃ¡vel',
            'Ajuda na Postura',
            'Discreta Sob Roupas',
          ],
          faqs: [
            { question: 'Quanto tempo devo usar por dia?', answer: 'Recomendamos usar por pelo menos 8 horas diÃ¡rias para melhores resultados. Pode usar durante todo o dia nas suas atividades normais.' },
            { question: 'Posso usar durante exercÃ­cios?', answer: 'Sim! A cinta pode ser usada durante exercÃ­cios leves e moderados, ajudando a intensificar os resultados.' },
            { question: 'Como escolher o tamanho correto?', answer: 'Consulte nossa tabela de medidas. Em caso de dÃºvida entre dois tamanhos, escolha o maior para maior conforto.' },
            { question: 'Posso dormir com a cinta?', answer: 'NÃ£o recomendamos dormir com a cinta. Use durante o dia nas suas atividades normais.' },
          ],
          customerReviews: [
            { id: 'm1', author: 'Mariana Santos', rating: 5, date: '2024-09-22', comment: 'Produto excelente! Uso todos os dias e jÃ¡ vejo muita diferenÃ§a na cintura. Super confortÃ¡vel!', verified: true },
            { id: 'm2', author: 'Luciana Ferreira', rating: 5, date: '2024-09-16', comment: 'Melhor cinta que jÃ¡ usei! Material de qualidade e realmente modela o corpo.', verified: true },
            { id: 'm3', author: 'Amanda Costa', rating: 4, date: '2024-09-11', comment: 'Muito boa! Ajudou muito na minha postura tambÃ©m. Recomendo!', verified: true },
          ],
          variants: [
            { id: 'pp', name: 'PP', price: 297.00, stock: 10 },
            { id: 'p', name: 'P', price: 297.00, stock: 12 },
            { id: 'm', name: 'M', price: 297.00, stock: 15 },
            { id: 'g', name: 'G', price: 297.00, stock: 8 },
            { id: 'gg', name: 'GG', price: 297.00, stock: 5 },
          ],
        },
        {
          id: '2',
          slug: 'cha-natural',
          name: 'GreenRush ChÃ¡ Natural',
          description: 'ChÃ¡ natural termogÃªnico desenvolvido com ingredientes selecionados para acelerar o metabolismo, reduzir a retenÃ§Ã£o de lÃ­quidos e controlar o apetite naturalmente.',
          price: 77.00,
          image: 'https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=800&h=800&fit=crop',
          images: [
            'https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1597318236557-c7a598c44228?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1564890369478-c89ca6d9cde9?w=800&h=800&fit=crop',
          ],
          category: 'Emagrecimento',
          stock: 120,
          badge: 'sale',
          rating: 4.8,
          reviews: 423,
          benefits: [
            'Acelera o metabolismo naturalmente',
            'Reduz a retenÃ§Ã£o de lÃ­quidos',
            'Controla o apetite',
            'Melhora a digestÃ£o',
            '100% natural',
            'Sem efeitos colaterais',
          ],
          ingredients: [
            'Camomila',
            'Erva-cidreira',
            'MaracujÃ¡',
            'Jasmim',
            'ChÃ¡ Verde',
            'ChÃ¡ Preto',
            'Boldo',
            'Carqueja',
            'HortelÃ£',
            'Funcho',
          ],
          howToUse: [
            'Prepare uma xÃ­cara de chÃ¡ utilizando Ã¡gua quente (nÃ£o fervente)',
            'Deixe em infusÃ£o por 3 a 5 minutos',
            'Tome 2 a 3 xÃ­caras por dia',
            'Recomenda-se tomar pela manhÃ£ e antes das principais refeiÃ§Ãµes',
          ],
          whyChoose: [
            'Aprovado pela ANVISA',
            '100% Natural e Seguro',
            'Sem CafeÃ­na, Sem AgitaÃ§Ã£o',
            'Resultados em poucas semanas',
            'Livre de Efeitos Colaterais',
          ],
          faqs: [
            { question: 'O chÃ¡ tem cafeÃ­na?', answer: 'NÃ£o! Nossa fÃ³rmula Ã© livre de cafeÃ­na, vocÃª pode tomar sem preocupaÃ§Ã£o com agitaÃ§Ã£o ou insÃ´nia.' },
            { question: 'Quantas xÃ­caras posso tomar por dia?', answer: 'Recomendamos de 2 a 3 xÃ­caras por dia, preferencialmente pela manhÃ£ e antes das refeiÃ§Ãµes principais.' },
            { question: 'Em quanto tempo vejo resultados?', answer: 'Os primeiros resultados comeÃ§am a aparecer nas primeiras semanas de uso contÃ­nuo.' },
            { question: 'Gestantes podem tomar?', answer: 'Recomendamos consultar seu mÃ©dico antes de iniciar qualquer suplementaÃ§Ã£o durante a gestaÃ§Ã£o.' },
          ],
          customerReviews: [
            { id: 'r1', author: 'Maria Silva', rating: 5, date: '2024-09-15', comment: 'Perdi 8kg em 2 meses tomando o chÃ¡ regularmente. Produto excelente!', verified: true },
            { id: 'r2', author: 'Ana Santos', rating: 5, date: '2024-09-10', comment: 'Ajudou muito a reduzir o inchaÃ§o. Recomendo!', verified: true },
            { id: 'r3', author: 'Juliana Costa', rating: 4, date: '2024-09-05', comment: 'Gostei bastante, o sabor Ã© agradÃ¡vel e me ajudou a controlar a ansiedade por doces.', verified: true },
          ],
          variants: [
            { id: '1pack', name: '1 Pacote (30 dias)', price: 77.00, originalPrice: 97.00, stock: 50 },
            { id: '3pack', name: '3 Pacotes (90 dias)', price: 197.00, originalPrice: 291.00, stock: 40 },
            { id: '5pack', name: '5 Pacotes (150 dias)', price: 297.00, originalPrice: 485.00, stock: 30 },
          ],
        },
        {
          id: '3',
          slug: 'capsulas',
          name: 'GreenRush CÃ¡psulas',
          description: 'Suplemento 100% natural em cÃ¡psulas para emagrecimento saudÃ¡vel. Acelera o metabolismo, sem efeitos colaterais. Resultados visÃ­veis em poucas semanas.',
          price: 149.90,
          originalPrice: 179.90,
          image: 'https://images.unsplash.com/photo-1471864190281-a93a3070b6de?w=800&h=800&fit=crop',
          images: [
            'https://images.unsplash.com/photo-1471864190281-a93a3070b6de?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1550572017-4cd4bc2d5ccf?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1584308972272-9e4e7685e80f?w=800&h=800&fit=crop',
          ],
          category: 'Emagrecimento',
          stock: 95,
          badge: 'bestseller',
          rating: 4.9,
          reviews: 812,
          benefits: [
            'Acelera o metabolismo',
            'Queima de gordura localizada',
            'Controla o apetite',
            'Aumenta a energia e disposiÃ§Ã£o',
            '100% natural',
            'Sem efeitos colaterais',
            'Resultados visÃ­veis em semanas',
          ],
          ingredients: [
            'Extrato de Laranja Moro',
            'GuaranÃ¡ em PÃ³',
            'CafeÃ­na Anidra',
            'Ãcido AscÃ³rbico (Vitamina C)',
            'Acetato de DL-alfa-tocoferol (Vitamina E)',
            'Acetato de Retinol (Vitamina A)',
            'Picolinato de Cromo',
            'Carbonato de CÃ¡lcio',
            'Estearato de MagnÃ©sio',
            'DiÃ³xido de SilÃ­cio',
          ],
          howToUse: [
            'Tome 1 cÃ¡psula pela manhÃ£ apÃ³s o cafÃ© da manhÃ£',
            'Tome 1 cÃ¡psula no final da tarde antes do jantar',
            'Beba bastante Ã¡gua ao longo do dia',
            'Use continuamente por pelo menos 90 dias para melhores resultados',
          ],
          whyChoose: [
            'Aprovado pela ANVISA',
            '100% Natural',
            'Sem Efeitos Colaterais',
            'Resultados nas Primeiras Semanas',
            'Acelera Metabolismo Naturalmente',
          ],
          faqs: [
            { question: 'As cÃ¡psulas sÃ£o naturais?', answer: 'Sim! 100% natural e aprovado pela ANVISA, sem efeitos colaterais.' },
            { question: 'Quantas cÃ¡psulas devo tomar por dia?', answer: 'Recomendamos 2 cÃ¡psulas ao dia: uma pela manhÃ£ apÃ³s o cafÃ© e outra no final da tarde antes do jantar.' },
            { question: 'Em quanto tempo vejo resultados?', answer: 'Resultados perceptÃ­veis nas primeiras semanas de uso contÃ­nuo.' },
            { question: 'Posso tomar durante a gravidez?', answer: 'Recomendamos consultar seu mÃ©dico antes de iniciar qualquer suplementaÃ§Ã£o durante a gestaÃ§Ã£o ou lactaÃ§Ã£o.' },
          ],
          customerReviews: [
            { id: 'c1', author: 'Fernanda Lima', rating: 5, date: '2024-09-20', comment: 'Produto maravilhoso! JÃ¡ eliminei 12kg e me sinto muito mais disposta.', verified: true },
            { id: 'c2', author: 'Carla Mendes', rating: 5, date: '2024-09-12', comment: 'Melhor suplemento que jÃ¡ usei. Sem efeitos colaterais e resultados rÃ¡pidos!', verified: true },
            { id: 'c3', author: 'PatrÃ­cia Oliveira', rating: 5, date: '2024-09-08', comment: 'Estou no segundo mÃªs e jÃ¡ perdi 9kg. Super recomendo!', verified: true },
          ],
          variants: [
            { id: '60caps', name: '60 CÃ¡psulas (1 mÃªs)', price: 149.90, originalPrice: 179.90, stock: 40 },
            { id: '180caps', name: '180 CÃ¡psulas (3 meses)', price: 347.00, originalPrice: 539.70, stock: 30 },
            { id: '300caps', name: '300 CÃ¡psulas (5 meses)', price: 547.00, originalPrice: 899.50, stock: 25 },
          ],
        },
        {
          id: '4',
          slug: 'slimshot',
          name: 'SlimShot - Vinagre de MaÃ§Ã£',
          description: 'Shot termogÃªnico de vinagre de maÃ§Ã£ concentrado para potencializar seus resultados no emagrecimento. Acelera o metabolismo e auxilia na queima de gordura.',
          price: 89.90,
          originalPrice: 119.90,
          image: 'https://images.unsplash.com/photo-1584308972272-9e4e7685e80f?w=800&h=800&fit=crop',
          images: [
            'https://images.unsplash.com/photo-1584308972272-9e4e7685e80f?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1622597467836-f3285f2131b8?w=800&h=800&fit=crop',
            'https://images.unsplash.com/photo-1610970881699-44a5587cabec?w=800&h=800&fit=crop',
          ],
          category: 'Emagrecimento',
          stock: 80,
          badge: 'new',
          rating: 4.7,
          reviews: 245,
          benefits: [
            'Acelera o metabolismo',
            'Auxilia na digestÃ£o',
            'Reduz o inchaÃ§o',
            'Controla a glicemia',
            'Detox natural',
            'Formato prÃ¡tico e rÃ¡pido',
          ],
          ingredients: [
            'Vinagre de MaÃ§Ã£ OrgÃ¢nico',
            'Extrato de Gengibre',
            'LimÃ£o',
            'Pimenta Caiena',
            'Mel OrgÃ¢nico',
          ],
          howToUse: [
            'Tome 1 shot pela manhÃ£ em jejum',
            'Pode diluir em Ã¡gua se preferir',
            'Recomenda-se uso diÃ¡rio',
            'Aguarde 15-20 minutos antes do cafÃ© da manhÃ£',
          ],
          whyChoose: [
            '100% Natural e OrgÃ¢nico',
            'Formato PrÃ¡tico e RÃ¡pido',
            'Potencializa Resultados',
            'Detox Natural',
            'Sabor AgradÃ¡vel',
          ],
          faqs: [
            { question: 'Como devo tomar o SlimShot?', answer: 'Tome 1 shot pela manhÃ£ em jejum. Pode diluir em Ã¡gua se preferir. Aguarde 15-20 minutos antes do cafÃ© da manhÃ£.' },
            { question: 'Posso tomar todos os dias?', answer: 'Sim! O uso diÃ¡rio Ã© recomendado para melhores resultados.' },
            { question: 'Tem gosto ruim?', answer: 'O sabor Ã© naturalmente cÃ­trico e agradÃ¡vel. A combinaÃ§Ã£o de limÃ£o e mel torna o shot saboroso.' },
            { question: 'Posso tomar com outros produtos GreenRush?', answer: 'Sim! O SlimShot pode ser combinado com nossas cÃ¡psulas e chÃ¡ para potencializar os resultados.' },
          ],
          customerReviews: [
            { id: 's1', author: 'Renata Oliveira', rating: 5, date: '2024-09-18', comment: 'Adoro! Super prÃ¡tico e me ajudou muito a desinchar. Tomo todos os dias antes do cafÃ©.', verified: true },
            { id: 's2', author: 'Beatriz Rocha', rating: 4, date: '2024-09-14', comment: 'O sabor Ã© bom e realmente funciona. Senti diferenÃ§a na digestÃ£o.', verified: true },
            { id: 's3', author: 'Camila Souza', rating: 5, date: '2024-09-09', comment: 'Combinei com as cÃ¡psulas e os resultados foram incrÃ­veis! JÃ¡ eliminei 6kg.', verified: true },
          ],
          variants: [
            { id: '15shots', name: '15 Shots (15 dias)', price: 89.90, originalPrice: 119.90, stock: 30 },
            { id: '30shots', name: '30 Shots (30 dias)', price: 159.90, originalPrice: 239.80, stock: 25 },
            { id: '60shots', name: '60 Shots (60 dias)', price: 279.90, originalPrice: 479.60, stock: 25 },
          ],
        },
      ],

      setProducts: (products) => set({ products }),

      addProduct: async (product) => {
        try {
          const API_URL = (import.meta as any).env?.VITE_API_BASE_URL || '/api';

          // Preparar dados para API
          const apiData = {
            name: product.name,
            description: product.description,
            shortDescription: product.shortDescription || product.description?.substring(0, 100) || '',
            price: product.price,
            originalPrice: product.originalPrice,
            category: product.category,
            stock: product.stock || 0,
            images: product.images || (product.image ? [product.image] : []),
            tags: product.tags || [],
            isFeatured: product.isFeatured || false,
            customLandingPage: product.customLandingPage || null,
          };

          console.log('ðŸ“¤ Enviando produto para API:', apiData);
          console.log('ðŸ“· Imagens que serÃ£o salvas:', apiData.images);

          const response = await fetch(`${API_URL}/products`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(apiData)
          });

          if (!response.ok) {
            const errorData = await response.json();
            console.error('âŒ Erro da API:', errorData);
            throw new Error(errorData.error?.message || 'Erro ao salvar produto');
          }

          const result = await response.json();
          console.log('âœ… Produto salvo na API:', result);

          // Atualizar localStorage com o produto retornado da API
          set((state) => ({
            products: [...state.products, { ...product, id: result.id, slug: result.slug }],
          }));

          // Recarregar para sincronizar com MySQL
          window.location.reload();
        } catch (error) {
          console.error('âŒ Erro ao adicionar produto:', error);
          alert('Erro ao salvar produto: ' + error);
        }
      },

      updateProduct: async (id, productData) => {
        try {
          const API_URL = (import.meta as any).env?.VITE_API_BASE_URL || '/api';

          // Preparar dados - converter image para images array
          const apiData: any = { ...productData };
          if (productData.image && !productData.images) {
            apiData.images = [productData.image];
            delete apiData.image;
          }

          console.log('ðŸ“¤ Atualizando produto na API:', apiData);
          console.log('ðŸ“· Imagens que serÃ£o salvas:', apiData.images);

          const response = await fetch(`${API_URL}/products/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(apiData)
          });

          if (!response.ok) throw new Error('Erro ao atualizar produto');

          console.log('âœ… Produto atualizado na API');

          // Atualizar localStorage
          set((state) => ({
            products: state.products.map((p) =>
              p.id === id ? { ...p, ...apiData } : p
            ),
          }));

          // Recarregar para sincronizar
          window.location.reload();
        } catch (error) {
          console.error('âŒ Erro ao atualizar produto:', error);
          alert('Erro ao atualizar produto: ' + error);
        }
      },

      deleteProduct: async (id) => {
        try {
          const API_URL = (import.meta as any).env?.VITE_API_BASE_URL || '/api';

          const response = await fetch(`${API_URL}/products/${id}`, {
            method: 'DELETE'
          });

          if (!response.ok) throw new Error('Erro ao deletar produto');

          console.log('âœ… Produto deletado da API');

          // Atualizar localStorage
          set((state) => ({
            products: state.products.filter((p) => p.id !== id),
          }));

          // Recarregar para sincronizar
          window.location.reload();
        } catch (error) {
          console.error('âŒ Erro ao deletar produto:', error);
          alert('Erro ao deletar produto: ' + error);
        }
      },

      getProductById: (id) => {
        const products = get().products;
        return Array.isArray(products) ? products.find((p) => p.id === id) : undefined;
      },

      getProductBySlug: (slug) => {
getProductsByCustomLanding: (landingPage) => {        const products = get().products;        return Array.isArray(products) ? products.filter((p) => p.customLandingPage === landingPage) : [];      },
        const products = get().products;
getProductsByCustomLanding: (landingPage) => {        const products = get().products;        return Array.isArray(products) ? products.filter((p) => p.customLandingPage === landingPage) : [];      },
        return Array.isArray(products) ? products.find((p) => p.slug === slug) : undefined;
getProductsByCustomLanding: (landingPage) => {        const products = get().products;        return Array.isArray(products) ? products.filter((p) => p.customLandingPage === landingPage) : [];      },
      },
getProductsByCustomLanding: (landingPage) => {        const products = get().products;        return Array.isArray(products) ? products.filter((p) => p.customLandingPage === landingPage) : [];      },

      getProductsByCategory: (category) => {
        const products = get().products;
        return Array.isArray(products) ? products.filter((p) =>
          p.category.toLowerCase() === category.toLowerCase()
        ) : [];
      },

      getAvailableProducts: () => {
        const products = get().products;
        return Array.isArray(products) ? products.filter((p) => !p.hidden) : [];
      },

      searchProducts: (query) => {
        const lowerQuery = query.toLowerCase();
        const products = get().products;
        return Array.isArray(products) ? products.filter((p) =>
          p.name.toLowerCase().includes(lowerQuery) ||
          p.description.toLowerCase().includes(lowerQuery) ||
          p.category.toLowerCase().includes(lowerQuery)
        ) : [];
      },

      addReview: (productSlug, review) => {
        set((state) => {
          const products = Array.isArray(state.products) ? state.products.map((p) => {
            if (p.slug === productSlug) {
              const newReview: ProductReview = {
                id: `r${Date.now()}`,
                date: new Date().toISOString().split('T')[0],
                verified: false,
                ...review,
              };

              const updatedReviews = [...(p.customerReviews || []), newReview];
              const totalRating = updatedReviews.reduce((sum, r) => sum + r.rating, 0);
              const avgRating = totalRating / updatedReviews.length;

              return {
                ...p,
                customerReviews: updatedReviews,
                rating: Number(avgRating.toFixed(1)),
                reviews: updatedReviews.length,
              };
            }
            return p;
          }) : [];

          return { products };
        });
      },

      updateReviewStatus: (productId, reviewId, status) => {
        set((state) => {
          const products = Array.isArray(state.products) ? state.products.map((p) => {
            if (p.id === productId) {
              return {
                ...p,
                customerReviews: (p.customerReviews || []).map((r) =>
                  r.id === reviewId ? { ...r, status } : r
                ),
              };
            }
            return p;
          }) : [];

          return { products };
        });
      },

      deleteReview: (productId, reviewId) => {
        set((state) => {
          const products = Array.isArray(state.products) ? state.products.map((p) => {
            if (p.id === productId) {
              const updatedReviews = (p.customerReviews || []).filter((r) => r.id !== reviewId);
              const totalRating = updatedReviews.reduce((sum, r) => sum + r.rating, 0);
              const avgRating = updatedReviews.length > 0 ? totalRating / updatedReviews.length : 0;

              return {
                ...p,
                customerReviews: updatedReviews,
                rating: Number(avgRating.toFixed(1)),
                reviews: updatedReviews.length,
              };
            }
            return p;
          }) : [];

          return { products };
        });
      },
    }),
    {
      name: 'product-storage',
      version: 6, // Reset com produtos mockados
    }
  )
);
